<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CampusConnect NG - Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
  :root {
    --primary-blue: #007BFF;
    --secondary-orange: #FF8C00;
    --tertiary-green: #28A745;
    --white-bg: #FFFFFF;
    --light-gray-bg: #F8F9FA;
    --text-color-dark: #212529;
    --text-color-light: #6C757D;
    --border-color: #CED4DA;
    --shadow-light: rgba(0,0,0,0.08);
    --shadow-medium: rgba(0,0,0,0.12);
    --success-bg: #D4EDDA;
    --success-border: #C3E6CB;
    --success-text: #155724;
    --whatsapp-color: #25D366;
    --whatsapp-dark-color: #1DA851;
  }
  body{
    font-family:'Segoe UI','Roboto',sans-serif;
    background:var(--light-gray-bg);
    margin:0;
    padding:0;
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  .header{
    width:100%;
    background:var(--primary-blue);
    color:var(--white-bg);
    padding:20px 0;
    text-align:center;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
  }
  .header h1{margin:0;font-size:1.8rem;font-weight:700;}
  .panel{
    width:90%; max-width:1000px;
    background:var(--white-bg);
    padding:30px;
    margin:30px auto;
    border-radius:12px;
    box-shadow:0 8px 25px var(--shadow-medium);
  }
  h2{text-align:center;color:var(--primary-blue);margin-bottom:25px;}
  .tabs{display:flex;margin-bottom:20px;border-bottom:2px solid var(--border-color);}
  .tab-button{
    background:var(--light-gray-bg);
    border:none;
    padding:10px 20px;
    cursor:pointer;
    font-size:1rem;
    font-weight:600;
    color:var(--text-color-light);
    border-top-left-radius:8px;
    border-top-right-radius:8px;
    margin-right:5px;
    border:1px solid transparent;
    border-bottom:none;
    transition:0.3s;
  }
  .tab-button.active{background:var(--white-bg);color:var(--primary-blue);border:1px solid var(--border-color);margin-bottom:-2px;}
  .tab-content{display:none;padding-top:20px;}
  .tab-content.active{display:block;}
  table{width:100%;border-collapse:collapse;background:var(--white-bg);}
  table th,table td{border:1px solid var(--border-color);padding:12px;text-align:left;color:var(--text-color-dark);}
  table th{background:var(--light-gray-bg);color:var(--primary-blue);}
  table tr:nth-child(even){background:#fcfdfe;}
  .button-group{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;margin-top:30px;}
  .action-button{padding:14px 30px;color:#fff;border:none;border-radius:8px;font-weight:bold;font-size:1.1rem;cursor:pointer;text-decoration:none;display:flex;align-items:center;justify-content:center;}
  .action-button i{margin-right:8px;}
  .action-button.green{background:var(--tertiary-green);}
  .action-button.green:hover{background:#218838;}
  .action-button.blue{background:var(--primary-blue);}
  .action-button.blue:hover{background:#0056b3;}
  .action-button.whatsapp-color{background:var(--whatsapp-color);}
  .action-button.whatsapp-color:hover{background:var(--whatsapp-dark-color);}
  .copy-status-message{margin-top:15px;text-align:center;font-size:0.95rem;color:var(--success-text);background:var(--success-bg);border:1px solid var(--success-border);padding:10px;border-radius:5px;display:none;}
  .vcf-batch-container{margin-top:20px;border:1px solid var(--border-color);border-radius:8px;padding:15px;background-color:var(--light-gray-bg);}
  .vcf-batch-container h3{color:var(--primary-blue);margin-top:0;margin-bottom:15px;font-size:1.3rem;border-bottom:1px solid var(--border-color);padding-bottom:10px;}
  .footer-love{text-align:center;font-size:0.85rem;color:var(--text-color-light);margin-top:30px;padding-bottom:15px;width:100%;}
  .footer-love a{color:var(--primary-blue);text-decoration:none;font-weight:500;}
  @media (max-width:768px){.panel{padding:20px;}h2{font-size:1.5rem;}table th,table td{padding:8px;font-size:0.85rem;}.action-button{width:100%;padding:12px 20px;font-size:1rem;}.button-group{flex-direction:column;gap:15px;}}
</style>
</head>
<body>

<div class="header">
  <h1>CampusConnect NG Admin Panel</h1>
</div>

<div class="panel">
  <div class="tabs">
    <button class="tab-button active" onclick="openTab(event,'vcf-downloads')">VCF Downloads</button>
    <button class="tab-button" onclick="openTab(event,'whatsapp-contacts')">WhatsApp Contacts</button>
    <button class="tab-button" onclick="openTab(event,'institution-view')">Institution View</button>
  </div>

  <!-- VCF Downloads -->
  <div id="vcf-downloads" class="tab-content active">
    <h2>VCF Contact List</h2>
    <div id="vcf-message" class="data-load-message">Loading contacts...</div>
    <div class="button-group">
      <button class="action-button green" onclick="downloadNewMembersVCF()"><i class="fas fa-arrow-down"></i> Download New Members</button>
      <button class="action-button blue" onclick="downloadAllMembersVCF()"><i class="fas fa-download"></i> Download All Members</button>
    </div>
    <div id="vcf-batch-downloads-container"></div>
  </div>

  <!-- WhatsApp Contacts -->
  <div id="whatsapp-contacts" class="tab-content">
    <h2>WhatsApp Contact List</h2>
    <div id="whatsapp-contacts-table" class="data-load-message">Loading WhatsApp contacts...</div>
    <div class="button-group">
      <button class="action-button whatsapp-color" onclick="copyAllWhatsAppNumbers()"><i class="fab fa-whatsapp"></i> Copy All WhatsApp Numbers</button>
    </div>
    <div id="copy-status" class="copy-status-message"></div>
  </div>

  <!-- Institution View -->
  <div id="institution-view" class="tab-content">
    <h2>Contacts by Institution</h2>
    <div id="institution-table" class="data-load-message">Loading data...</div>
  </div>

</div>

<div class="footer-love">
  Created with ❤️ by <a href="#" target="_blank">CampusConnect NG</a>
</div>

<script>
const API_URL="https://sheetdb.io/api/v1/lcqbyo961rmzf";
const CONTACTS_PER_BATCH=100;
let allContactsData=[];

function openTab(evt,tabName){
  document.querySelectorAll(".tab-content").forEach(tc=>tc.style.display="none");
  document.querySelectorAll(".tab-button").forEach(tb=>tb.classList.remove("active"));
  document.getElementById(tabName).style.display="block";
  evt.currentTarget.classList.add("active");
  if(tabName==="whatsapp-contacts") displayWhatsAppContacts(allContactsData);
  else if(tabName==="institution-view") displayInstitutionView(allContactsData);
}

// Fetch contacts from API
async function fetchAllContacts(){
  try{
    const res=await fetch(API_URL);
    const data=await res.json();
    allContactsData=data.filter(entry=>entry.name && entry.phone);
    displayVCFMessage(allContactsData);
  }catch(e){
    console.error(e);
    document.getElementById("vcf-message").innerHTML="Failed to load contacts.";
  }
}

// Display contacts message
function displayVCFMessage(data){
  if(!data || data.length===0) document.getElementById("vcf-message").innerHTML="No contacts available.";
  else document.getElementById("vcf-message").innerHTML=`Total contacts: ${data.length}`;
}

// Generate VCF
function generateVCFContent(contact){
  if(!contact || !contact.name || !contact.phone) return '';
  return `BEGIN:VCARD\r\nVERSION:3.0\r\nFN:${contact.name}\r\nN:${contact.name};;;\r\nTEL;TYPE=CELL:${contact.phone}\r\nNOTE:State:${contact.state || ''} | Institution:${contact.institution || ''}\r\nEND:VCARD\r\n`;
}

// Download VCF batch
function downloadVCFBatches(contacts,filenamePrefix){
  const totalBatches=Math.ceil(contacts.length/CONTACTS_PER_BATCH);
  const now=new Date();
  const folderDate=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
  const folderTime=`${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
  const container=document.getElementById('vcf-batch-downloads-container');
  container.innerHTML='';
  for(let i=0;i<totalBatches;i++){
    const batch=contacts.slice(i*CONTACTS_PER_BATCH,(i+1)*CONTACTS_PER_BATCH);
    let content='';
    batch.forEach(c=>content+=generateVCFContent(c));
    const filename=`${filenamePrefix}_Batch${i+1}_${folderDate}_${folderTime}.vcf`;
    const blob=new Blob([content],{type:"text/vcard;charset=utf-8"});
    const blobUrl=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=blobUrl;a.download=filename;
    a.className='action-button green';
    a.innerHTML=`<i class="fas fa-file-download"></i> Download Batch ${i+1} (${batch.length} contacts)`;
    container.appendChild(a);
  }
  alert(`${totalBatches} VCF batches ready for download.`);
}

// Download new members (last 7 days for example)
function downloadNewMembersVCF(){
  const now=new Date();
  const cutoff=new Date(); cutoff.setDate(now.getDate()-7);
  const newMembers=allContactsData.filter(c=>new Date(c.joindate)>=cutoff);
  if(newMembers.length===0){alert("No new members found.");return;}
  downloadVCFBatches(newMembers,'CampusConnect_NewMembers');
}

// Download all members
function downloadAllMembersVCF(){
  if(allContactsData.length===0){alert("No contacts available.");return;}
  downloadVCFBatches(allContactsData,'CampusConnect_AllMembers');
}

// Display WhatsApp contacts
function displayWhatsAppContacts(data){
  const div=document.getElementById('whatsapp-contacts-table');
  if(!data || data.length===0){div.innerHTML="No WhatsApp contacts.";return;}
  let table=`<table><thead><tr><th>S/N</th><th>Name</th><th>Phone</th><th>State</th></tr></thead><tbody>`;
  data.forEach((c,i)=>{table+=`<tr><td>${i+1}</td><td>${c.name}</td><td>${c.phone}</td><td>${c.state || ''}</td></tr>`;});
  table+='</tbody></table>'; div.innerHTML=table;
}

// Copy all WhatsApp numbers
function copyAllWhatsAppNumbers(){
  const numbers=allContactsData.map(c=>c.phone).filter(p=>p).join('\n');
  const div=document.getElementById('copy-status');
  if(numbers){
    navigator.clipboard.writeText(numbers).then(()=>{div.innerText=`Copied ${allContactsData.length} numbers!`;div.style.display='block';setTimeout(()=>div.style.display='none',5000);});
  }else{div.innerText='No numbers to copy.';div.style.display='block';setTimeout(()=>div.style.display='none',5000);}
}

// Institution view
function displayInstitutionView(data){
  const div=document.getElementById('institution-table');
  if(!data || data.length===0){div.innerHTML="No data available.";return;}
  const institutions={};
  data.forEach(c=>{const inst=c.institution||'Unknown';if(!institutions[inst]) institutions[inst]=[];institutions[inst].push(c);});
  let html='';
  for(const inst in institutions){
    html+=`<h3>${inst} (${institutions[inst].length} contacts)</h3>`;
  }
  div.innerHTML=html;
}

// Initialize
document.addEventListener('DOMContentLoaded',fetchAllContacts);
</script>

</body>
</html>
