<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CampusConnect NG – Admin VCF Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
--blue:#007BFF;
--green:#28A745;
--red:#DC3545;
--gray:#6c757d;
--light:#f8f9fa;
--border:#ced4da;
}
body{
margin:0;
font-family:Segoe UI,Roboto,sans-serif;
background:var(--light);
display:flex;
justify-content:center;
}
.container{
width:95%;
max-width:950px;
background:#fff;
margin:30px 0;
padding:30px;
border-radius:12px;
box-shadow:0 8px 25px rgba(0,0,0,.15);
}
h1{text-align:center;color:var(--blue);}
.tabs{display:flex;gap:10px;border-bottom:2px solid var(--border);margin-bottom:20px;flex-wrap:wrap;}
.tab{padding:10px 18px;cursor:pointer;font-weight:600;color:var(--gray);}
.tab.active{color:var(--blue);border-bottom:3px solid var(--blue);}
.actions{margin:15px 0;display:flex;gap:15px;flex-wrap:wrap;}
button{border:none;padding:12px 22px;border-radius:8px;font-weight:700;color:#fff;cursor:pointer;}
.btn-green{background:var(--green)}
.btn-blue{background:var(--blue)}
.btn-red{background:var(--red)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--border);padding:9px;font-size:.9rem}
th{background:#f1f3f5}
.badge{padding:3px 8px;border-radius:10px;font-size:.75rem;color:#fff;font-weight:bold}
.badge-new{background:var(--green)}
.badge-old{background:var(--red)}
.hidden{display:none}
.footer{text-align:center;margin-top:20px;font-size:.85rem;color:#666}
</style>
</head>

<body>

<div class="container">
<h1>Admin VCF Download Panel</h1>

<div class="tabs">
<div class="tab active" onclick="openTab('main')">Members</div>
<div class="tab" onclick="openTab('mark')">Mark as Downloaded</div>
<div class="tab" onclick="openTab('institution')">Institutions</div>
</div>

<!-- MEMBERS -->
<div id="main">
<div class="actions">
<button class="btn-green" onclick="downloadNew()">⬇ Download NEW</button>
<button class="btn-blue" onclick="downloadAll()">⬇ Download ALL</button>
</div>
<div id="members-table">Loading…</div>
</div>

<!-- MARK -->
<div id="mark" class="hidden">
<div class="actions">
<button class="btn-red" onclick="markAllOld()">✅ Mark ALL NEW as OLD</button>
</div>
<div id="mark-table"></div>
</div>

<!-- INSTITUTION -->
<div id="institution" class="hidden">
<div id="institution-table"></div>
</div>

<div class="footer">CampusConnect NG • Admin Only</div>
</div>

<script>
const API="https://sheetdb.io/api/v1/lcqbyo961rmzf";
let contacts=[];

/* TABS */
function openTab(id){
document.querySelectorAll('#main,#mark,#institution').forEach(d=>d.classList.add('hidden'));
document.getElementById(id).classList.remove('hidden');
}

/* LOAD DATA */
async function load(){
try{
const res=await fetch(API);
contacts=await res.json();
contacts.sort((a,b)=>new Date(b.joindate)-new Date(a.joindate));
renderMain();
}catch(e){
document.getElementById("members-table").innerHTML="Failed to load data.";
}
}
load();
setInterval(load,10000);

/* MAIN TABLE */
function renderMain(){
document.getElementById("members-table").innerHTML=`
<table>
<tr><th>Status</th><th>Name</th><th>State</th><th>Phone</th></tr>
${contacts.map(c=>{
const isNew=c.status!=='old';
return `
<tr>
<td><span class="badge ${isNew?'badge-new':'badge-old'}">${isNew?'NEW':'OLD'}</span></td>
<td>${c.name}</td>
<td>${c.state||''}</td>
<td>${c.phone}</td>
</tr>`;
}).join('')}
</table>`;
}

/* DOWNLOAD NEW */
function downloadNew(){
const list=contacts.filter(c=>c.status!=='old');
if(!list.length) return alert("No NEW members.");
downloadVCF(list,"CampusConnect_NEW.vcf");
}

/* DOWNLOAD ALL */
function downloadAll(){
downloadVCF(contacts,"CampusConnect_ALL.vcf");
}

/* VCF */
function downloadVCF(list,name){
const content=list.map(c=>`BEGIN:VCARD
VERSION:3.0
FN:${c.name}
TEL:${c.phone}
END:VCARD`).join("\n");
const blob=new Blob([content],{type:"text/vcard"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download=name;
a.click();
}

/* MARK OLD */
async function markAllOld(){
if(!confirm("Mark all NEW as OLD?")) return;
const list=contacts.filter(c=>c.status!=='old');
for(const c of list){
await fetch(`${API}/search?phone=${encodeURIComponent(c.phone)}`,{
method:"PATCH",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({data:[{status:"old"}]})
});
}
alert("All NEW marked as OLD");
load();
}

/* INSTITUTIONS */
function renderInstitutionTable(){
const map={};
contacts.forEach(c=>{
const k=c.institution||"Unknown";
map[k]=(map[k]||0)+1;
});
document.getElementById("institution-table").innerHTML=`
<table>
<tr><th>Institution</th><th>Total</th></tr>
${Object.entries(map).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join('')}
</table>`;
}
</script>

</body>
</html>
