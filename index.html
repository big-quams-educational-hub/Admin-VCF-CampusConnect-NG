<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CampusConnect NG - Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
:root{
  --primary-blue:#007BFF; --secondary-orange:#FF8C00; --tertiary-green:#28A745;
  --white-bg:#FFFFFF; --light-gray-bg:#F8F9FA; --text-color-dark:#212529;
  --text-color-light:#6C757D; --border-color:#CED4DA; --shadow-light:rgba(0,0,0,0.08);
  --shadow-medium:rgba(0,0,0,0.12); --success-bg:#D4EDDA; --success-text:#155724;
}
body{
  font-family:Segoe UI,Roboto,sans-serif;
  background:var(--light-gray-bg);
  margin:0; padding:0; display:flex; flex-direction:column; align-items:center; min-height:100vh; color:var(--text-color-dark);
}
.header{width:100%; background-color:var(--primary-blue); color:var(--white-bg); padding:15px 0; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.header h1{margin:0; font-size:1.8rem; font-weight:700;}
.panel{max-width:900px; width:90%; margin:30px auto; background:var(--white-bg); padding:30px; border-radius:12px; box-shadow:0 8px 25px var(--shadow-medium);}
h2{text-align:center; color:var(--primary-blue); font-size:1.8rem; margin-bottom:25px; font-weight:700;}
.tabs{display:flex; margin-bottom:20px; border-bottom:2px solid var(--border-color);}
.tab-button{background-color:var(--light-gray-bg); border:none; padding:10px 20px; cursor:pointer; font-size:1rem; font-weight:600; color:var(--text-color-light); border-top-left-radius:8px; border-top-right-radius:8px; transition:background-color 0.3s, color 0.3s; margin-right:5px; border:1px solid transparent; border-bottom:none;}
.tab-button:hover{background-color:#E9ECEF;color:var(--text-color-dark);}
.tab-button.active{background-color:var(--white-bg); color:var(--primary-blue); border:1px solid var(--border-color); border-bottom:2px solid var(--white-bg); margin-bottom:-2px; box-shadow:0 -2px 8px var(--shadow-light);}
.tab-content{display:none; padding-top:20px;}
.tab-content.active{display:block;}
table{width:100%; margin-top:20px; border-collapse:collapse; background-color:var(--white-bg); border-radius:8px; overflow:hidden;}
table th,table td{border:1px solid var(--border-color); padding:12px 15px; font-size:0.95rem; text-align:left; color:var(--text-color-dark);}
table th{background-color:var(--light-gray-bg); font-weight:600; color:var(--primary-blue);}
table tr:nth-child(even){background-color:#fcfdfe;}
.button-group{display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin-top:30px;}
.action-button{width:fit-content; min-width:200px; padding:15px 30px; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:1.1rem; transition:background-color 0.3s, transform 0.2s, box-shadow 0.3s; display:flex; align-items:center; justify-content:center; text-decoration:none;}
.action-button i{margin-right:8px;}
.action-button.green{background-color:var(--tertiary-green); box-shadow:0 4px 10px rgba(40,167,69,0.2);}
.action-button.green:hover{background-color:#218838; transform:translateY(-2px); box-shadow:0 6px 15px rgba(40,167,69,0.3);}
.action-button.blue{background-color:var(--primary-blue); box-shadow:0 4px 10px rgba(0,123,255,0.2);}
.action-button.blue:hover{background-color:#0056b3; transform:translateY(-2px); box-shadow:0 6px 15px rgba(0,123,255,0.3);}
.vcf-batch-container{margin-top:20px; border:1px solid var(--border-color); border-radius:8px; padding:15px; background-color:var(--light-gray-bg);}
.vcf-batch-container h3{color:var(--primary-blue); margin-top:0; margin-bottom:15px; font-size:1.3rem; border-bottom:1px solid var(--border-color); padding-bottom:10px;}
.vcf-batch-container .button-group{justify-content:flex-start; margin-top:10px; gap:10px;}
.footer-love{text-align:center; font-size:0.85rem; color:var(--text-color-light); margin-top:30px; padding-bottom:15px; width:100%;}
.footer-love a{color:var(--primary-blue); text-decoration:none; font-weight:500;}
@media (max-width:768px){.panel{padding:20px;} h2{font-size:1.5rem;} table th,table td{padding:8px 10px; font-size:0.85rem;} .action-button{min-width:unset;width:100%;padding:12px 20px;font-size:1rem;} .button-group{flex-direction:column; gap:15px;} .vcf-batch-container .button-group{flex-direction:column; align-items:flex-start;} .vcf-batch-container .action-button{width:fit-content;}}
</style>
</head>
<body>

<div class="header"><h1>CampusConnect NG Admin Panel</h1></div>

<div class="panel">

  <div class="tabs">
    <button class="tab-button active" onclick="openTab(event,'new-members')">New Members</button>
    <button class="tab-button" onclick="openTab(event,'old-members')">Old Members</button>
  </div>

  <div id="new-members" class="tab-content active">
    <h2>New Members (after last download)</h2>
    <div id="data-table" class="data-load-message">Loading contacts...</div>
    <div class="button-group">
      <button class="action-button green" onclick="downloadNewMembersVCF()"><i class="fas fa-arrow-down"></i> Download New Members VCF</button>
      <button class="action-button blue" onclick="generateAllNewMembersBatches()"><i class="fas fa-download"></i> Generate New Members Batches</button>
    </div>
    <div id="vcf-batch-downloads-container"></div>
  </div>

  <div id="old-members" class="tab-content">
    <h2>Old Members (before last download)</h2>
    <div id="old-members-table" class="data-load-message">Loading old members...</div>
    <div class="button-group">
      <button class="action-button green" onclick="downloadOldMembersVCF()"><i class="fas fa-arrow-down"></i> Download Old Members VCF</button>
      <button class="action-button blue" onclick="generateAllOldMembersBatches()"><i class="fas fa-download"></i> Generate Old Members Batches</button>
    </div>
    <div id="vcf-old-batch-container"></div>
  </div>

</div>

<div class="footer-love">Created with ❤️ by <a href="#">CampusConnect NG</a></div>

<script>
const API_URL="https://sheetdb.io/api/v1/lcqbyo961rmzf";
const CONTACTS_PER_BATCH=100;
let allContactsData=[];

function openTab(evt,tabName){
  let tabcontent=document.getElementsByClassName("tab-content");
  for(let i=0;i<tabcontent.length;i++){tabcontent[i].style.display="none";}
  let tabbuttons=document.getElementsByClassName("tab-button");
  for(let i=0;i<tabbuttons.length;i++){tabbuttons[i].className=tabbuttons[i].className.replace(" active","");}
  document.getElementById(tabName).style.display="block";
  evt.currentTarget.className+=" active";
  if(tabName==='new-members'){displayNewMembersTable(allContactsData);}
  else if(tabName==='old-members'){displayOldMembersTable(allContactsData);}
}

function generateVCFContent(contact){
  if(!contact||!contact.name||!contact.phone)return'';
  const name=contact.name.trim();
  const phone=contact.phone.trim().replace(/\D/g,'');
  const state=contact.state?contact.state.trim():'';
  const inst=contact.institution?contact.institution.trim():'';
  let vcf=`BEGIN:VCARD\r\nVERSION:3.0\r\n`;
  vcf+=`FN:${name}\r\nN:${name};;;\r\n`;
  vcf+=`TEL;TYPE=CELL:${phone}\r\n`;
  if(state||inst){vcf+=`NOTE:State:${state}, Institution:${inst}\r\n`;}
  vcf+=`END:VCARD\r\n`;
  return vcf;
}

async function fetchAllDataAndDisplay(){
  try{
    const resp=await fetch(API_URL);
    const rawData=await resp.json();
    allContactsData=rawData;
    displayNewMembersTable(allContactsData);
    displayOldMembersTable(allContactsData);
  }catch(e){console.error(e); document.getElementById("data-table").innerHTML="Failed to load data.";}
}

function getLastDownloadTime(){return localStorage.getItem("campusconnect_last_download")||null;}
function setLastDownloadTime(){localStorage.setItem("campusconnect_last_download",new Date().toISOString());}
function getNewMembers(){const last=getLastDownloadTime(); if(!last)return allContactsData; return allContactsData.filter(c=>new Date(c.joindate)>new Date(last));}
function getOldMembers(){const last=getLastDownloadTime(); if(!last)return[]; return allContactsData.filter(c=>new Date(c.joindate)<=new Date(last));}

function displayNewMembersTable(data){
  const tableDiv=document.getElementById("data-table");
  const members=getNewMembers();
  if(!members||members.length===0){tableDiv.innerHTML="No new contacts since last download."; return;}
  let html=`<table><thead><tr><th>Name</th><th>State</th><th>Institution</th><th>Phone</th><th>Join Date</th></tr></thead><tbody>`;
  members.forEach(e=>{html+=`<tr><td>${e.name||'N/A'}</td><td>${e.state||'N/A'}</td><td>${e.institution||'N/A'}</td><td>${e.phone||'N/A'}</td><td>${e.joindate||'N/A'}</td></tr>`;});
  html+="</tbody></table>"; tableDiv.innerHTML=html;
}
function displayOldMembersTable(data){
  const tableDiv=document.getElementById("old-members-table");
  const members=getOldMembers();
  if(!members||members.length===0){tableDiv.innerHTML="No old contacts found."; return;}
  let html=`<table><thead><tr><th>Name</th><th>State</th><th>Institution</th><th>Phone</th><th>Join Date</th></tr></thead><tbody>`;
  members.forEach(e=>{html+=`<tr><td>${e.name||'N/A'}</td><td>${e.state||'N/A'}</td><td>${e.institution||'N/A'}</td><td>${e.phone||'N/A'}</td><td>${e.joindate||'N/A'}</td></tr>`;});
  html+="</tbody></table>"; tableDiv.innerHTML=html;
}

// DOWNLOAD FUNCTIONS
function downloadNewMembersVCF(){const members=getNewMembers(); if(!members.length){alert("No new members since last download."); return;} let vcf=''; members.forEach(c=>vcf+=generateVCFContent(c)); const blob=new Blob([vcf],{type:"text/vcard;charset=utf-8"}); const link=document.createElement("a"); link.href=URL.createObjectURL(blob); link.download="CampusConnect_NG_NewMembers.vcf"; document.body.appendChild(link); link.click(); document.body.removeChild(link); setLastDownloadTime(); alert(`${members.length} new members downloaded.`);}
function downloadOldMembersVCF(){const members=getOldMembers(); if(!members.length){alert("No old members found."); return;} let vcf=''; members.forEach(c=>vcf+=generateVCFContent(c)); const blob=new Blob([vcf],{type:"text/vcard;charset=utf-8"}); const link=document.createElement("a"); link.href=URL.createObjectURL(blob); link.download="CampusConnect_NG_OldMembers.vcf"; document.body.appendChild(link); link.click(); document.body.removeChild(link); alert(`${members.length} old members downloaded.`);}
function generateAllNewMembersBatches(){const members=getNewMembers(); if(!members.length){alert("No new members since last download."); return;} const container=document.getElementById("vcf-batch-downloads-container"); container.innerHTML=''; const total=Math.ceil(members.length/CONTACTS_PER_BATCH); for(let i=0;i<total;i++){const batch=members.slice(i*CONTACTS_PER_BATCH,(i+1)*CONTACTS_PER_BATCH); let vcf=''; batch.forEach(c=>vcf+=generateVCFContent(c)); const blob=new Blob([vcf],{type:"text/vcard;charset=utf-8"}); const link=document.createElement("a"); link.href=URL.createObjectURL(blob); link.download=`CampusConnect_NG_Batch_${i+1}.vcf`; link.className='action-button green'; link.innerHTML=`<i class="fas fa-file-download"></i> Batch ${i+1} (${batch.length} contacts)`; container.appendChild(link);} setLastDownloadTime();}
function generateAllOldMembersBatches(){const members=getOldMembers(); if(!members.length){alert("No old members found."); return;} const container=document.getElementById("vcf-old-batch-container"); container.innerHTML=''; const total=Math.ceil(members.length/CONTACTS_PER_BATCH); for(let i=0;i<total;i++){const batch=members.slice(i*CONTACTS_PER_BATCH,(i+1)*CONTACTS_PER_BATCH); let vcf=''; batch.forEach(c=>vcf+=generateVCFContent(c)); const blob=new Blob([vcf],{type:"text/vcard;charset=utf-8"}); const link=document.createElement("a"); link.href=URL.createObjectURL(blob); link.download=`CampusConnect_NG_OldBatch_${i+1}.vcf`; link.className='action-button green'; link.innerHTML=`<i class="fas fa-file-download"></i> Batch ${i+1} (${batch.length} contacts)`; container.appendChild(link);}
document.addEventListener("DOMContentLoaded",fetchAllDataAndDisplay);
</script>

</body>
</html>
