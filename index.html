<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CampusConnect NG â€“ Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">

<style>
:root{
--blue:#0d6efd;
--green:#198754;
--red:#dc3545;
--light:#f8f9fa;
--border:#dee2e6;
}
body{
margin:0;
font-family:system-ui,-apple-system,Segoe UI,Roboto;
background:var(--light);
}
#offlineBanner{
display:none;
background:var(--red);
color:#fff;
padding:8px;
text-align:center;
font-weight:700;
}
.container{
max-width:1100px;
margin:auto;
padding:15px;
}
h1{text-align:center;color:var(--blue)}
.tabs{
display:flex;
gap:10px;
flex-wrap:wrap;
border-bottom:2px solid var(--border);
margin-bottom:15px;
}
.tab{
padding:10px 16px;
cursor:pointer;
font-weight:600;
}
.tab.active{
border-bottom:3px solid var(--blue);
color:var(--blue);
}
.actions{
display:flex;
gap:10px;
flex-wrap:wrap;
margin-bottom:15px;
}
button{
border:none;
padding:10px 16px;
border-radius:8px;
font-weight:700;
cursor:pointer;
color:#fff;
}
.green{background:var(--green)}
.red{background:var(--red)}
.blue{background:var(--blue)}

table{
width:100%;
border-collapse:collapse;
background:#fff;
}
th,td{
border:1px solid var(--border);
padding:8px;
font-size:.9rem;
}
th{background:#f1f3f5}

.badge{
padding:4px 8px;
border-radius:10px;
font-size:.75rem;
font-weight:700;
color:#fff;
}
.new{background:var(--green)}
.old{background:var(--red)}

.hidden{display:none}
</style>
</head>

<body>

<div id="offlineBanner">ðŸ“´ Offline mode â€” showing last saved data</div>

<div class="container">
<h1>CampusConnect NG Admin</h1>

<div class="tabs">
<div class="tab active" onclick="openTab('members')">Members</div>
<div class="tab" onclick="openTab('institutions')">Institutions</div>
<div class="tab" onclick="openTab('downloads')">Downloads</div>
</div>

<!-- MEMBERS -->
<div id="members">
<div class="actions">
<button class="green" onclick="downloadType('new')">â¬‡ Download NEW</button>
<button class="red" onclick="downloadType('old')">â¬‡ Download OLD</button>
<button class="blue" onclick="downloadType('all')">â¬‡ Download ALL</button>
</div>
<div id="membersTable">Loadingâ€¦</div>
</div>

<!-- INSTITUTIONS -->
<div id="institutions" class="hidden">
<div id="institutionTable"></div>
</div>

<!-- DOWNLOADS -->
<div id="downloads" class="hidden">
<div id="downloadInfo">Select a download option above.</div>
</div>

</div>

<script>
const API="https://sheetdb.io/api/v1/lcqbyo961rmzf";
let contacts=[];

/* TABS */
function openTab(id){
document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
event.target.classList.add('active');
["members","institutions","downloads"].forEach(x=>document.getElementById(x).classList.add("hidden"));
document.getElementById(id).classList.remove("hidden");
}

/* ONLINE STATUS */
function updateOnline(){
document.getElementById("offlineBanner").style.display=navigator.onLine?"none":"block";
}
window.addEventListener("online",updateOnline);
window.addEventListener("offline",updateOnline);
updateOnline();

/* LOAD DATA */
async function load(){
try{
const res=await fetch(API);
contacts=await res.json();
localStorage.setItem("cc_cache",JSON.stringify(contacts));
renderMembers();
renderInstitutions();
}catch{
const cache=localStorage.getItem("cc_cache");
if(cache){
contacts=JSON.parse(cache);
renderMembers();
renderInstitutions();
}else{
document.getElementById("membersTable").innerHTML="âŒ No data available";
}
}
}
load();
setInterval(load,15000);

/* RENDER MEMBERS */
function renderMembers(){
const rows=contacts.map(c=>{
const isOld=c.status==="old";
return `<tr>
<td><span class="badge ${isOld?'old':'new'}">${isOld?'OLD':'NEW'}</span></td>
<td>${c.name||''}</td>
<td>${c.state||''}</td>
<td>${c.phone||''}</td>
<td>${c.institution||''}</td>
</tr>`;
}).join("");

document.getElementById("membersTable").innerHTML=`
<table>
<tr><th>Status</th><th>Name</th><th>State</th><th>Phone</th><th>Institution</th></tr>
${rows}
</table>`;
}

/* INSTITUTION ANALYSIS */
function renderInstitutions(){
const map={};
contacts.forEach(c=>{
const k=c.institution||"Unknown";
map[k]=(map[k]||0)+1;
});
document.getElementById("institutionTable").innerHTML=`
<table>
<tr><th>Institution</th><th>Total</th></tr>
${Object.entries(map).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("")}
</table>`;
}

/* DOWNLOAD LOGIC */
function downloadType(type){
if(!navigator.onLine) return alert("Offline â€” cannot download");

let list=[...contacts];
if(type==="new") list=list.filter(c=>c.status!=="old");
if(type==="old") list=list.filter(c=>c.status==="old");

const unique={};
list.forEach(c=>unique[c.phone]=c);
list=Object.values(unique);

const chunks=[];
while(list.length) chunks.push(list.splice(0,100));

chunks.forEach((chunk,i)=>{
const vcf=chunk.map(c=>{
const st=(c.state||"").substring(0,3).toUpperCase();
return `BEGIN:VCARD
VERSION:3.0
FN:${c.name} (${st})
TEL:${c.phone}
END:VCARD`;
}).join("\n");

const blob=new Blob([vcf],{type:"text/vcard"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download=`CampusConnect_${type}_${i+1}.vcf`;
a.click();
});

autoMarkOld();
}

/* AUTO MARK OLD */
async function autoMarkOld(){
for(const c of contacts.filter(c=>c.status!=="old")){
await fetch(`${API}/search?phone=${encodeURIComponent(c.phone)}`,{
method:"PATCH",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({data:[{status:"old"}]})
});
}
load();
}

/* SERVICE WORKER */
if('serviceWorker' in navigator){
navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
