<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CampusConnect NG – Admin VCF Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
--blue:#007BFF;
--green:#28A745;
--red:#DC3545;
--gray:#6c757d;
--light:#f4f6f9;
--border:#dee2e6;
--card:#ffffff;
}

*{box-sizing:border-box}

body{
margin:0;
font-family:Segoe UI,Roboto,sans-serif;
background:var(--light);
}

.container{
max-width:1100px;
margin:20px auto;
background:var(--card);
padding:20px;
border-radius:14px;
box-shadow:0 10px 30px rgba(0,0,0,.08);
}

h1{
text-align:center;
color:var(--blue);
margin-bottom:15px;
font-size:1.6rem;
}

.tabs{
display:flex;
gap:10px;
border-bottom:2px solid var(--border);
margin-bottom:15px;
overflow-x:auto;
}

.tab{
padding:10px 16px;
cursor:pointer;
font-weight:600;
color:var(--gray);
white-space:nowrap;
}

.tab.active{
color:var(--blue);
border-bottom:3px solid var(--blue);
}

.actions{
margin:15px 0;
display:flex;
gap:12px;
flex-wrap:wrap;
}

button{
border:none;
padding:12px 18px;
border-radius:10px;
font-weight:700;
color:#fff;
cursor:pointer;
font-size:.9rem;
}

.btn-green{background:var(--green)}
.btn-blue{background:var(--blue)}
.btn-red{background:var(--red)}

.table-wrap{
overflow-x:auto;
}

table{
width:100%;
border-collapse:collapse;
min-width:600px;
}

th,td{
border:1px solid var(--border);
padding:10px;
font-size:.9rem;
text-align:left;
}

th{
background:#f1f3f5;
font-weight:700;
}

.badge{
padding:4px 10px;
border-radius:12px;
font-size:.7rem;
color:#fff;
font-weight:700;
}

.badge-new{background:var(--green)}
.badge-old{background:var(--red)}

.hidden{display:none}

.card{
background:#f8f9fa;
border-radius:12px;
padding:15px;
margin-bottom:15px;
}

.footer{
text-align:center;
margin-top:20px;
font-size:.8rem;
color:#777;
}

/* MOBILE */
@media(max-width:600px){
h1{font-size:1.3rem}
button{width:100%}
}
</style>
</head>

<body>

<div class="container">
<h1>CampusConnect NG – Admin Panel</h1>

<div class="tabs">
<div class="tab active" onclick="openTab('main',this)">Members</div>
<div class="tab" onclick="openTab('mark',this)">Mark as Downloaded</div>
<div class="tab" onclick="openTab('institution',this)">Institutions</div>
</div>

<!-- MEMBERS -->
<div id="main">
<div class="actions">
<button class="btn-green" onclick="downloadNew()">⬇ Download NEW</button>
<button class="btn-blue" onclick="downloadAll()">⬇ Download ALL</button>
</div>
<div class="table-wrap" id="members-table">Loading…</div>
</div>

<!-- MARK -->
<div id="mark" class="hidden">
<div class="actions">
<button class="btn-red" onclick="markAllOld()">✅ Mark ALL NEW as OLD</button>
</div>
<div class="table-wrap" id="mark-table"></div>
</div>

<!-- INSTITUTION -->
<div id="institution" class="hidden">
<div class="table-wrap" id="institution-table"></div>
</div>

<div class="footer">CampusConnect NG • Admin Only</div>
</div>

<script>
const API="https://sheetdb.io/api/v1/lcqbyo961rmzf";
let contacts=[];

/* TAB HANDLER */
function openTab(id,el){
document.querySelectorAll('#main,#mark,#institution').forEach(d=>d.classList.add('hidden'));
document.getElementById(id).classList.remove('hidden');
document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
el.classList.add('active');

if(id==='institution') renderInstitutionTable();
if(id==='mark') renderMarkTable();
}

/* LOAD DATA */
async function load(){
try{
const res=await fetch(API);
contacts=await res.json();
contacts.sort((a,b)=>new Date(b.joindate)-new Date(a.joindate));
renderMain();
}catch(e){
document.getElementById("members-table").innerHTML="❌ Failed to load data.";
}
}
load();
setInterval(load,10000);

/* MAIN */
function renderMain(){
document.getElementById("members-table").innerHTML=`
<table>
<tr><th>Status</th><th>Name</th><th>State</th><th>Phone</th></tr>
${contacts.map(c=>{
const isNew=c.status!=='old';
return `
<tr>
<td><span class="badge ${isNew?'badge-new':'badge-old'}">${isNew?'NEW':'OLD'}</span></td>
<td>${c.name||''}</td>
<td>${c.state||''}</td>
<td>${c.phone||''}</td>
</tr>`;
}).join('')}
</table>`;
}

/* DOWNLOADS */
function downloadNew(){
const list=contacts.filter(c=>c.status!=='old');
if(!list.length) return alert("No NEW members.");
downloadVCF(list,"CampusConnect_NEW.vcf");
}

function downloadAll(){
downloadVCF(contacts,"CampusConnect_ALL.vcf");
}

function downloadVCF(list,name){
const content=list.map(c=>`BEGIN:VCARD
VERSION:3.0
FN:${c.name}
TEL:${c.phone}
END:VCARD`).join("\n");
const blob=new Blob([content],{type:"text/vcard"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download=name;
a.click();
}

/* MARK OLD */
async function markAllOld(){
if(!confirm("Mark all NEW as OLD?")) return;
const list=contacts.filter(c=>c.status!=='old');
for(const c of list){
await fetch(`${API}/search?phone=${encodeURIComponent(c.phone)}`,{
method:"PATCH",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({data:[{status:"old"}]})
});
}
alert("All NEW marked as OLD");
load();
}

/* MARK TABLE */
function renderMarkTable(){
const list=contacts.filter(c=>c.status!=='old');
document.getElementById("mark-table").innerHTML=`
<table>
<tr><th>Name</th><th>Phone</th><th>State</th></tr>
${list.map(c=>`
<tr>
<td>${c.name||''}</td>
<td>${c.phone||''}</td>
<td>${c.state||''}</td>
</tr>`).join('')}
</table>`;
}

/* INSTITUTION ANALYSIS */
function renderInstitutionTable(){
const map={};
contacts.forEach(c=>{
const key=c.institution||"Unknown";
map[key]=(map[key]||0)+1;
});
const total=contacts.length||1;

document.getElementById("institution-table").innerHTML=`
<table>
<tr><th>Institution</th><th>Total</th><th>%</th></tr>
${Object.entries(map)
.sort((a,b)=>b[1]-a[1])
.map(([k,v])=>`
<tr>
<td>${k}</td>
<td>${v}</td>
<td>${((v/total)*100).toFixed(1)}%</td>
</tr>`).join('')}
</table>`;
}
</script>

</body>
</html>
