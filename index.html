<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CampusConnect NG – Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
--blue:#007BFF;
--green:#28A745;
--red:#DC3545;
--gray:#6c757d;
--light:#f8f9fa;
--border:#ced4da;
--shadow:rgba(0,0,0,.15);
}
body{
margin:0;
font-family:Segoe UI,Roboto,sans-serif;
background:var(--light);
display:flex;
justify-content:center;
}
.container{
width:95%;
max-width:1000px;
background:#fff;
margin:20px 0;
padding:20px;
border-radius:12px;
box-shadow:0 8px 25px var(--shadow);
}
h1{text-align:center;color:var(--blue);margin-bottom:20px;}

.tabs{
display:flex;
gap:10px;
border-bottom:2px solid var(--border);
margin-bottom:20px;
flex-wrap:wrap;
}
.tab{
padding:10px 18px;
cursor:pointer;
font-weight:600;
color:var(--gray);
border-radius:8px 8px 0 0;
}
.tab.active{
background:#fff;
color:var(--blue);
border:1px solid var(--border);
border-bottom:none;
}

.actions{
margin:15px 0;
display:flex;
gap:10px;
flex-wrap:wrap;
}
button{
border:none;
padding:10px 18px;
border-radius:8px;
font-weight:700;
cursor:pointer;
color:#fff;
}
.btn-green{background:var(--green);}
.btn-blue{background:var(--blue);}
.btn-red{background:var(--red);}

table{
width:100%;
border-collapse:collapse;
}
th,td{
border:1px solid var(--border);
padding:9px;
font-size:.9rem;
transition: background 0.3s;
}
th{background:#f1f3f5}
.badge{
padding:3px 8px;
border-radius:10px;
font-size:.75rem;
color:#fff;
font-weight:bold;
}
.badge-new{background:var(--green);}
.badge-old{background:var(--red);}

.hidden{display:none;}
.footer{text-align:center;margin-top:20px;font-size:.85rem;color:#666}
.batch-box{
border:1px solid var(--border);
padding:15px;
border-radius:10px;
margin-bottom:15px;
background:#f8f9fa;
}
@media(max-width:768px){
.actions{flex-direction:column;}
}
</style>
</head>
<body>
<div class="container">
<h1>CampusConnect NG – Admin Panel</h1>

<div class="tabs">
<div class="tab active" id="tab-members" onclick="openTab('members')">Members</div>
<div class="tab" id="tab-institutions" onclick="openTab('institutions')">By Institution</div>
<div class="tab" id="tab-download" onclick="openTab('download')">Download</div>
</div>

<!-- MEMBERS TAB -->
<div id="members">
<div class="actions">
<button class="btn-green" onclick="markAllOld()">✅ Mark All NEW as OLD</button>
</div>
<div id="members-table">Loading…</div>
</div>

<!-- INSTITUTIONS TAB -->
<div id="institutions" class="hidden">
<div class="actions">
<select id="inst-filter" onchange="renderInstitutionTable()"></select>
</div>
<div id="inst-table"></div>
</div>

<!-- DOWNLOAD TAB -->
<div id="download" class="hidden">
<div class="actions">
<button class="btn-green" onclick="downloadMembers('new')">⬇ Download NEW</button>
<button class="btn-red" onclick="downloadMembers('old')">⬇ Download OLD</button>
<button class="btn-blue" onclick="downloadMembers('all')">⬇ Download ALL</button>
</div>
<div id="download-info"></div>
</div>

<div class="footer">CampusConnect NG • Admin Only</div>
</div>

<script>
const API="https://sheetdb.io/api/v1/lcqbyo961rmzf";
const BATCH_SIZE=100;
let contacts=[];

// Tabs
function openTab(tab){
document.querySelectorAll('#members,#institutions,#download').forEach(d=>d.classList.add('hidden'));
document.getElementById(tab).classList.remove('hidden');
document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
document.getElementById('tab-'+tab).classList.add('active');
if(tab==='institutions') renderInstitutionTable();
}

// Load data
async function loadContacts(){
try{
  const res = await fetch(API);
  contacts = await res.json();
  contacts.sort((a,b)=>new Date(b.joindate)-new Date(a.joindate));
  renderMembersTable();
}catch(e){
  document.getElementById("members-table").innerHTML="Failed to load data.";
}
}
loadContacts();
setInterval(loadContacts,10000);

// Render Members Table
function renderMembersTable(){
document.getElementById("members-table").innerHTML=`
<table>
<tr><th>Status</th><th>Name</th><th>State</th><th>Institution</th><th>Phone</th></tr>
${contacts.map(c=>`<tr>
<td><span class="badge ${c.status==='old'?'badge-old':'badge-new'}">${c.status==='old'?'OLD':'NEW'}</span></td>
<td>${c.name}</td>
<td>${c.state}</td>
<td>${c.institution}</td>
<td>${c.phone}</td>
</tr>`).join('')}
</table>`;
}

// Render Institution Table
function renderInstitutionTable(){
const instSet = new Set(contacts.map(c=>c.institution || "Unknown"));
const instFilter = document.getElementById("inst-filter");
instFilter.innerHTML=`<option value="">All Institutions</option>`;
[...instSet].sort().forEach(i=>{
  const o = document.createElement("option");
  o.value=i;
  o.textContent=i;
  instFilter.appendChild(o);
});
const filter = instFilter.value;
const filtered = filter ? contacts.filter(c=>c.institution===filter) : contacts;
document.getElementById("inst-table").innerHTML=`
<table>
<tr><th>Status</th><th>Name</th><th>State</th><th>Phone</th></tr>
${filtered.map(c=>`<tr>
<td><span class="badge ${c.status==='old'?'badge-old':'badge-new'}">${c.status==='old'?'OLD':'NEW'}</span></td>
<td>${c.name}</td>
<td>${c.state}</td>
<td>${c.phone}</td>
</tr>`).join('')}
</table>`;
}

// Download Members
function downloadMembers(type){
let list;
if(type==='new') list = contacts.filter(c=>c.status!=='old');
else if(type==='old') list = contacts.filter(c=>c.status==='old');
else list = contacts;
if(!list.length){alert(`No ${type.toUpperCase()} members.`); return;}

// Remove duplicates
const seen = new Set();
list = list.filter(c=>!seen.has(c.phone) && seen.add(c.phone));

let batchCount = 0;
for(let i=0;i<list.length;i+=BATCH_SIZE){
  const batch = list.slice(i,i+BATCH_SIZE);
  const content = batch.map(c=>`BEGIN:VCARD
VERSION:3.0
FN:${c.name}
ORG:${c.institution}
TEL:${c.phone}
END:VCARD`).join("\n");
  const blob = new Blob([content],{type:"text/vcard"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download=`CampusConnect_${type}_Batch_${++batchCount}.vcf`;
  a.click();
  URL.revokeObjectURL(a.href);
}

// Auto-mark new as old after download
if(type==='new') markAllOld();
document.getElementById("download-info").innerHTML=`${batchCount} batch(es) of ${type.toUpperCase()} members downloaded.`;
}

// Mark all new as old
async function markAllOld(){
const newContacts = contacts.filter(c=>c.status!=='old');
for(const c of newContacts){
try{
await fetch(`${API}/search?phone=${encodeURIComponent(c.phone)}`,{
method:'PATCH',
headers:{'Content-Type':'application/json'},
body: JSON.stringify({data:[{status:'old'}]})
});
c.status='old';
}catch(e){console.error(e);}
}
renderMembersTable();
renderInstitutionTable();
alert("All NEW members marked as OLD!");
}
</script>

</body>
</html>
