<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CampusConnect NG – Admin VCF Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
--blue:#007BFF;
--green:#28A745;
--red:#DC3545;
--gray:#6c757d;
--light:#f8f9fa;
--border:#ced4da;
--shadow:rgba(0,0,0,.15);
}
body{
margin:0;
font-family:Segoe UI,Roboto,sans-serif;
background:var(--light);
display:flex;
justify-content:center;
}
.container{
width:95%;
max-width:950px;
background:#fff;
margin:30px 0;
padding:30px;
border-radius:12px;
box-shadow:0 8px 25px var(--shadow);
}
h1{text-align:center;color:var(--blue);}

.tabs{
display:flex;
gap:10px;
border-bottom:2px solid var(--border);
margin-bottom:20px;
flex-wrap:wrap;
}
.tab{
padding:10px 18px;
cursor:pointer;
font-weight:600;
color:var(--gray);
border-radius:8px 8px 0 0;
}
.tab.active{
background:#fff;
color:var(--blue);
border:1px solid var(--border);
border-bottom:none;
}

.actions{
margin:15px 0;
display:flex;
gap:15px;
flex-wrap:wrap;
}
button{
border:none;
padding:12px 22px;
border-radius:8px;
font-weight:700;
cursor:pointer;
color:#fff;
}
.btn-green{background:var(--green)}
.btn-blue{background:var(--blue)}
.btn-red{background:var(--red)}

table{
width:100%;
border-collapse:collapse;
}
th,td{
border:1px solid var(--border);
padding:9px;
font-size:.9rem;
transition: background 1s;
}
th{background:#f1f3f5}
.badge{
padding:3px 8px;
border-radius:10px;
font-size:.75rem;
color:#fff;
font-weight:bold;
}
.badge-new{background:var(--green);}
.badge-old{background:var(--red);}

.hidden{display:none}

.batch-box{
border:1px solid var(--border);
padding:15px;
border-radius:10px;
margin-bottom:15px;
background:#f8f9fa;
}

.footer{
text-align:center;
margin-top:20px;
font-size:.85rem;
color:#666;
}
</style>
</head>

<body>

<div class="container">
<h1>Admin VCF Download Panel</h1>

<div class="tabs">
<div class="tab active" id="tab-main" onclick="openTab('main')">Members</div>
<div class="tab" id="tab-batches" onclick="openTab('batches')">VCF Batches</div>
<div class="tab" id="tab-mark" onclick="openTab('mark')">Mark as Downloaded</div>
<div class="tab" id="tab-institution" onclick="openTab('institution')">Institutions</div>
</div>

<!-- MAIN VIEW -->
<div id="main" class="tab-content">
<div class="actions">
<button class="btn-green" onclick="downloadAndMarkNew()">⬇ Download NEW Members</button>
<button class="btn-blue" onclick="prepareBatches('old')">⬇ Download OLD Members</button>
<button class="btn-blue" onclick="downloadAll()">⬇ Download ALL Members</button>
</div>
<div id="members-table">Loading…</div>
</div>

<!-- BATCH VIEW -->
<div id="batches" class="tab-content hidden">
<div class="actions">
<button class="btn-blue" onclick="openTab('main')">⬅ Back to Members</button>
</div>
<div id="batch-area"></div>
</div>

<!-- MARK AS DOWNLOADED VIEW -->
<div id="mark" class="tab-content hidden">
<div class="actions">
<button class="btn-red" onclick="markNewAsOld()">✅ Mark All NEW as OLD</button>
</div>
<div id="mark-table">Loading…</div>
</div>

<!-- INSTITUTIONS VIEW -->
<div id="institution" class="tab-content hidden">
<div class="actions">
<button class="btn-blue" onclick="openTab('main')">⬅ Back to Members</button>
</div>
<div id="institution-table">Loading…</div>
</div>

<div class="footer">CampusConnect NG • Admin Only</div>
</div>

<script>
const API="https://sheetdb.io/api/v1/lcqbyo961rmzf";
const BATCH_SIZE=100;
let contacts=[];

/* ---------- TAB HANDLER ---------- */
function openTab(tab){
document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));
document.getElementById(tab).classList.remove('hidden');
document.getElementById(`tab-${tab}`).classList.add('active');
if(tab==='mark') renderMarkTable();
if(tab==='institution') renderInstitutionTable();
}

/* ---------- HELPERS ---------- */
function normalize(p){
let n=p.replace(/\D/g,"");
if(n.startsWith("0")) n=n.slice(1);
if(!n.startsWith("234")) n="234"+n;
return "+"+n;
}

function vcf(c){
return `BEGIN:VCARD
VERSION:3.0
FN:${c.name}
TEL:${normalize(c.phone)}
NOTE:${c.state||""}
END:VCARD
`;
}

/* ---------- LOAD DATA ---------- */
async function load(){
try{
  const res=await fetch(API);
  const data=await res.json();
  contacts = data;
  renderMain();
}catch(e){
  console.error(e);
}
}
// Auto-refresh every 2 seconds
setInterval(load,2000);
load();

/* ---------- RENDER MAIN TABLE ---------- */
function renderMain(){
document.getElementById("members-table").innerHTML=`
<table>
<tr>
<th>Status</th><th>Name</th><th>State</th><th>Phone</th><th>Joined</th>
</tr>
${contacts.map(c=>{
const isNew = !c.status || c.status==='new';
const badgeClass = isNew ? 'badge-new' : 'badge-old';
return `<tr>
<td><span class="badge ${badgeClass}">${isNew?'NEW':'OLD'}</span></td>
<td>${c.name}</td>
<td>${c.state||''}</td>
<td>${c.phone}</td>
<td>${new Date(c.joindate).toLocaleString()}</td>
</tr>`;
}).join('')}
</table>`;
}

/* ---------- DOWNLOAD & MARK NEW MEMBERS ---------- */
async function downloadAndMarkNew(){
const newMembers = contacts.filter(c=>!c.status || c.status==='new');
if(newMembers.length===0){alert("No NEW members."); return;}
openTab('batches');
renderBatches(newMembers,'new');
newMembers.forEach(c=>c.status='old');
renderMain();
for(const c of newMembers){
  try{
    let res = await fetch(`${API}/search?phone=${encodeURIComponent(c.phone)}`);
    let exist = await res.json();
    if(exist.length>0){
      await fetch(`${API}/search?phone=${encodeURIComponent(c.phone)}`,{
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ data:[{status:'old'}] })
      });
    } else {
      await fetch(API,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ data:[{name:c.name,phone:c.phone,status:'old',state:c.state||'',institution:c.institution||''}] })
      });
    }
  }catch(e){ console.error(e); }
}
alert("NEW members downloaded and marked as OLD!");
}

/* ---------- BATCH RENDER ---------- */
function renderBatches(list,type){
let html="";
for(let i=0;i<list.length;i+=BATCH_SIZE){
const batch=list.slice(i,i+BATCH_SIZE);
const content=batch.map(vcf).join("");
const blob=new Blob([content],{type:"text/vcard"});
const url=URL.createObjectURL(blob);

html+=`
<div class="batch-box">
<b>${type.toUpperCase()} Batch ${i/BATCH_SIZE+1}</b><br>
${batch.length} contacts<br><br>
<a href="${url}" download="CampusConnect_${type}_Batch_${i/BATCH_SIZE+1}.vcf">
<button class="btn-green">⬇ Download</button>
</a>
</div>`;
}
document.getElementById("batch-area").innerHTML=html;
}

/* ---------- DOWNLOAD ALL ---------- */
function downloadAll(){
const blob=new Blob([contacts.map(vcf).join("")],{type:"text/vcard"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="CampusConnect_ALL.vcf";
a.click();
URL.revokeObjectURL(a.href);
}

/* ---------- OLD MEMBERS ---------- */
function prepareBatches(type){
const list = type==='old'
? contacts.filter(c=>c.status==='old')
: contacts.filter(c=>!c.status || c.status==='new');
if(!list.length){alert(`No ${type.toUpperCase()} members.`); return;}
openTab('batches');
renderBatches(list,type);
}

/* ---------- MARK AS DOWNLOADED TAB ---------- */
async function markNewAsOld(){
const newContacts = contacts.filter(c=>!c.status || c.status==='new');
if(newContacts.length===0){alert("No NEW members."); return;}
newContacts.forEach(c=>c.status='old');
renderMain();
renderMarkTable();
for(const c of newContacts){
  try{
    let res = await fetch(`${API}/search?phone=${encodeURIComponent(c.phone)}`);
    let exist = await res.json();
    if(exist.length>0){
      await fetch(`${API}/search?phone=${encodeURIComponent(c.phone)}`,{
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ data:[{status:'old'}] })
      });
    } else {
      await fetch(API,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ data:[{name:c.name,phone:c.phone,status:'old',state:c.state||'',institution:c.institution||''}] })
      });
    }
  }catch(e){ console.error(e); }
}
alert("All NEW members marked as OLD!");
}

function renderMarkTable(){
const newContacts = contacts.filter(c=>!c.status || c.status==='new');
document.getElementById("mark-table").innerHTML=`
<table>
<tr><th>Name</th><th>Phone</th><th>State</th><th>Joined</th></tr>
${newContacts.map(c=>`<tr>
<td>${c.name}</td>
<td>${c.phone}</td>
<td>${c.state||''}</td>
<td>${new Date(c.joindate).toLocaleString()}</td>
</tr>`).join('')}
</table>`;
}

/* ---------- INSTITUTIONS TAB ---------- */
function renderInstitutionTable(){
const tableDiv = document.getElementById("institution-table");
if(contacts.length===0){ tableDiv.innerHTML="No data"; return; }
tableDiv.innerHTML=`
<table>
<tr><th>Name</th><th>Phone</th><th>Institution</th><th>Status</th></tr>
${contacts.map(c=>{
const badgeClass = (!c.status || c.status==='new') ? 'badge-new' : 'badge-old';
return `<tr>
<td>${c.name}</td>
<td>${c.phone}</td>
<td>${c.institution||''}</td>
<td><span class="badge ${badgeClass}">${(!c.status || c.status==='new') ? 'NEW' : 'OLD'}</span></td>
</tr>`;
}).join('')}
</table>`;
}
</script>

</body>
</html>
