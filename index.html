<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CampusConnect NG - Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
body{
  font-family:'Segoe UI','Roboto',sans-serif;
  background:#f8f9fa;
  margin:0;
  padding:0;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.header{
  width:100%;
  background:#007BFF;
  color:#fff;
  padding:20px 0;
  text-align:center;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}
.header h1{margin:0;font-size:1.8rem;font-weight:700;}
.panel{
  width:90%; max-width:1000px;
  background:#fff;
  padding:30px;
  margin:30px auto;
  border-radius:12px;
  box-shadow:0 8px 25px rgba(0,0,0,0.12);
}
.tabs{display:flex;margin-bottom:20px;border-bottom:2px solid #ced4da;}
.tab-button{
  background:#f8f9fa;
  border:none;
  padding:10px 20px;
  cursor:pointer;
  font-weight:600;
  color:#6c757d;
  border-top-left-radius:8px;
  border-top-right-radius:8px;
  margin-right:5px;
  border:1px solid transparent;
  border-bottom:none;
}
.tab-button.active{
  background:#fff;
  color:#007BFF;
  border:1px solid #ced4da;
  margin-bottom:-2px;
}
.tab-content{display:none;}
.tab-content.active{display:block;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
table th,table td{border:1px solid #ced4da;padding:10px;text-align:left;}
table th{background:#f8f9fa;color:#007BFF;}
tr:nth-child(even){background:#fcfdfe;}
.button-group{display:flex;flex-wrap:wrap;gap:15px;margin-top:20px;}
.action-button{padding:12px 20px;color:#fff;border:none;border-radius:8px;font-weight:bold;cursor:pointer;display:flex;align-items:center;}
.action-button i{margin-right:8px;}
.green{background:#28a745;}
.green:hover{background:#218838;}
.blue{background:#007BFF;}
.blue:hover{background:#0056b3;}
.orange{background:#ff8c00;}
.orange:hover{background:#e07b00;}
</style>
</head>
<body>

<div class="header">
  <h1>CampusConnect NG Admin Panel</h1>
</div>

<div class="panel">
  <div class="tabs">
    <button class="tab-button active" onclick="openTab(event,'vcf-list')">VCF Contacts</button>
    <button class="tab-button" onclick="openTab(event,'mark-download')">Mark New as Downloaded</button>
  </div>

  <!-- VCF List Tab -->
  <div id="vcf-list" class="tab-content active">
    <h2>All Contacts</h2>
    <div id="contacts-table">Loading contacts...</div>
    <div class="button-group">
      <button class="action-button green" onclick="downloadVCF('New')"><i class="fas fa-download"></i> Download New Contacts</button>
      <button class="action-button blue" onclick="downloadVCF('Old')"><i class="fas fa-download"></i> Download Old Contacts</button>
    </div>
    <div id="vcf-batches"></div>
  </div>

  <!-- Mark as Download Tab -->
  <div id="mark-download" class="tab-content">
    <h2>Mark New Contacts as Downloaded</h2>
    <p>Click the button below to mark all contacts with <strong>status = New</strong> as downloaded. They will automatically be tagged as Old.</p>
    <div class="button-group">
      <button class="action-button orange" onclick="markAsDownloaded()"><i class="fas fa-check"></i> Mark All New as Downloaded</button>
    </div>
  </div>

</div>

<script>
const API_URL="https://sheetdb.io/api/v1/lcqbyo961rmzf";
const CONTACTS_PER_BATCH=100;
let contacts=[];

document.addEventListener('DOMContentLoaded',fetchContacts);

function openTab(evt,tabName){
  document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(tb=>tb.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  evt.currentTarget.classList.add('active');
}

async function fetchContacts(){
  try{
    const res=await fetch(API_URL);
    const data=await res.json();
    contacts=data.filter(c=>c.name && c.phone);
    renderContactsTable();
  }catch(e){
    console.error(e);
    document.getElementById('contacts-table').innerHTML='Failed to load contacts.';
  }
}

function renderContactsTable(){
  if(!contacts.length){
    document.getElementById('contacts-table').innerHTML='No contacts found.';
    return;
  }
  let html=`<table>
    <thead>
      <tr><th>#</th><th>Name</th><th>Phone</th><th>State</th><th>Institution</th><th>Status</th><th>Join Date</th></tr>
    </thead><tbody>`;
  contacts.forEach((c,i)=>{
    html+=`<tr>
      <td>${i+1}</td>
      <td>${c.name}</td>
      <td>${c.phone}</td>
      <td>${c.state||''}</td>
      <td>${c.institution||''}</td>
      <td>${c.status||'New'}</td>
      <td>${c.joindate||''}</td>
    </tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('contacts-table').innerHTML=html;
}

function generateVCF(contact){
  return `BEGIN:VCARD\r\nVERSION:3.0\r\nFN:${contact.name}\r\nN:${contact.name};;;\r\nTEL;TYPE=CELL:${contact.phone}\r\nNOTE:State:${contact.state||''} | Institution:${contact.institution||''}\r\nEND:VCARD\r\n`;
}

function downloadVCF(status){
  const filtered=contacts.filter(c=>c.status===status);
  if(!filtered.length){alert(`No ${status} contacts found.`);return;}
  const totalBatches=Math.ceil(filtered.length/CONTACTS_PER_BATCH);
  const container=document.getElementById('vcf-batches');
  container.innerHTML='';
  const now=new Date();
  const dateStr=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
  for(let i=0;i<totalBatches;i++){
    const batch=filtered.slice(i*CONTACTS_PER_BATCH,(i+1)*CONTACTS_PER_BATCH);
    let vcfContent='';
    batch.forEach(c=>vcfContent+=generateVCF(c));
    const blob=new Blob([vcfContent],{type:'text/vcard;charset=utf-8'});
    const blobUrl=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=blobUrl;
    a.download=`CampusConnect_${status}_Batch${i+1}_${dateStr}.vcf`;
    a.className='action-button green';
    a.innerHTML=`<i class="fas fa-file-download"></i> Download Batch ${i+1} (${batch.length} contacts)`;
    container.appendChild(a);
  }
  alert(`${totalBatches} batch(es) ready for ${status} contacts.`);
}

async function markAsDownloaded(){
  if(!confirm("Are you sure you want to mark all New contacts as downloaded?")) return;
  const newContacts=contacts.filter(c=>c.status==='New');
  for(const c of newContacts){
    await fetch(`${API_URL}/id/${c.id}`,{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({data:{status:'Old'}})
    });
    c.status='Old';
  }
  alert(`${newContacts.length} contacts marked as Old.`);
  renderContactsTable();
  document.getElementById('vcf-batches').innerHTML='';
}
</script>

</body>
</html>
