<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CampusConnect NG – Admin VCF Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
--blue:#007BFF;
--green:#28A745;
--gray:#6c757d;
--light:#f8f9fa;
--border:#ced4da;
--shadow:rgba(0,0,0,.15);
}
body{
margin:0;
font-family:Segoe UI,Roboto,sans-serif;
background:var(--light);
display:flex;
justify-content:center;
}
.container{
width:95%;
max-width:950px;
background:#fff;
margin:30px 0;
padding:30px;
border-radius:12px;
box-shadow:0 8px 25px var(--shadow);
}
h1{text-align:center;color:var(--blue);}

.tabs{
display:flex;
gap:10px;
border-bottom:2px solid var(--border);
margin-bottom:20px;
}
.tab{
padding:10px 18px;
cursor:pointer;
font-weight:600;
color:var(--gray);
border-radius:8px 8px 0 0;
}
.tab.active{
background:#fff;
color:var(--blue);
border:1px solid var(--border);
border-bottom:none;
}

.actions{
margin:15px 0;
display:flex;
gap:15px;
flex-wrap:wrap;
}
button{
border:none;
padding:12px 22px;
border-radius:8px;
font-weight:700;
cursor:pointer;
color:#fff;
}
.btn-green{background:var(--green)}
.btn-blue{background:var(--blue)}

table{
width:100%;
border-collapse:collapse;
}
th,td{
border:1px solid var(--border);
padding:9px;
font-size:.9rem;
}
th{background:#f1f3f5}
.new{background:#e6fffa;font-weight:600}
.badge{
background:var(--green);
color:#fff;
padding:3px 8px;
border-radius:10px;
font-size:.75rem;
}

.hidden{display:none}

.batch-box{
border:1px solid var(--border);
padding:15px;
border-radius:10px;
margin-bottom:15px;
background:#f8f9fa;
}

.footer{
text-align:center;
margin-top:20px;
font-size:.85rem;
color:#666;
}
</style>
</head>

<body>

<div class="container">
<h1>Admin VCF Download Panel</h1>

<div class="tabs">
<div class="tab active" id="tab-main" onclick="openTab('main')">Members</div>
<div class="tab" id="tab-batches" onclick="openTab('batches')">VCF Batches</div>
</div>

<!-- MAIN VIEW -->
<div id="main" class="tab-content">
<div class="actions">
<button class="btn-green" onclick="prepareBatches('new')">⬇ Download NEW Members</button>
<button class="btn-blue" onclick="prepareBatches('old')">⬇ Download OLD Members</button>
<button class="btn-blue" onclick="downloadAll()">⬇ Download ALL Members</button>
</div>
<div id="members-table">Loading…</div>
</div>

<!-- BATCH VIEW -->
<div id="batches" class="tab-content hidden">
<div class="actions">
<button class="btn-blue" onclick="openTab('main')">⬅ Back to Members</button>
</div>
<div id="batch-area"></div>
</div>

<div class="footer">CampusConnect NG • Admin Only</div>
</div>

<script>
const API="https://sheetdb.io/api/v1/lcqbyo961rmzf";
const TRACK_ID=2;
const TRACK_COL="admin_last_download";
const BATCH_SIZE=100;

let contacts=[];
let lastDownload=new Date("2000-01-01");

/* ---------- TAB HANDLER (FIXED) ---------- */
function openTab(tab){
document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));

document.getElementById(tab).classList.remove('hidden');
document.getElementById(`tab-${tab}`).classList.add('active');
}

/* ---------- HELPERS ---------- */
function normalize(p){
let n=p.replace(/\D/g,"");
if(n.startsWith("0")) n=n.slice(1);
if(!n.startsWith("234")) n="234"+n;
return "+"+n;
}

function vcf(c){
return `BEGIN:VCARD
VERSION:3.0
FN:${c.name}
TEL:${normalize(c.phone)}
NOTE:${c.state||""}
END:VCARD
`;
}

/* ---------- LOAD DATA ---------- */
async function load(){
const res=await fetch(API);
const data=await res.json();

const track=data.find(r=>r.id==TRACK_ID);
if(track && track[TRACK_COL]) lastDownload=new Date(track[TRACK_COL]);

contacts=data.filter(r=>r.id!=TRACK_ID);
renderMain();
}
load();

/* ---------- RENDER MAIN TABLE ---------- */
function renderMain(){
document.getElementById("members-table").innerHTML=`
<table>
<tr>
<th>Status</th><th>Name</th><th>State</th><th>Phone</th><th>Joined</th>
</tr>
${contacts.map(c=>{
const isNew=new Date(c.joindate)>lastDownload;
return `
<tr class="${isNew?'new':''}">
<td>${isNew?'<span class="badge">NEW</span>':'OLD'}</td>
<td>${c.name}</td>
<td>${c.state}</td>
<td>${c.phone}</td>
<td>${new Date(c.joindate).toLocaleString()}</td>
</tr>`;
}).join("")}
</table>`;
}

/* ---------- BATCH PREP ---------- */
function prepareBatches(type){
const list=type==='new'
? contacts.filter(c=>new Date(c.joindate)>lastDownload)
: contacts.filter(c=>new Date(c.joindate)<=lastDownload);

if(!list.length){
alert(`No ${type.toUpperCase()} members available.`);
return;
}

openTab('batches');
renderBatches(list,type);

if(type==='new'){
fetch(`${API}/id/${TRACK_ID}`,{
method:"PUT",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({data:{[TRACK_COL]:new Date().toISOString()}})
});
}
}

/* ---------- RENDER BATCHES ---------- */
function renderBatches(list,type){
let html="";
for(let i=0;i<list.length;i+=BATCH_SIZE){
const batch=list.slice(i,i+BATCH_SIZE);
const content=batch.map(vcf).join("");
const blob=new Blob([content],{type:"text/vcard"});
const url=URL.createObjectURL(blob);

html+=`
<div class="batch-box">
<b>${type.toUpperCase()} Batch ${i/BATCH_SIZE+1}</b><br>
${batch.length} contacts<br><br>
<a href="${url}" download="CampusConnect_${type}_Batch_${i/BATCH_SIZE+1}.vcf">
<button class="btn-green">⬇ Download</button>
</a>
</div>`;
}
document.getElementById("batch-area").innerHTML=html;
}

/* ---------- DOWNLOAD ALL ---------- */
function downloadAll(){
const blob=new Blob([contacts.map(vcf).join("")],{type:"text/vcard"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="CampusConnect_ALL.vcf";
a.click();
URL.revokeObjectURL(a.href);
}
</script>

</body>
</html>
